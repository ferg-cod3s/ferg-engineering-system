{
  "id": "HP-002",
  "category": "hard-problems",
  "title": "Optimize Slow Database Query Hitting 10M+ Rows",
  "task": "Optimize a database query that takes 45+ seconds to execute on a table with 10M+ rows. The query is used for generating monthly reports and times out during peak business hours. Provide query optimization, indexing strategy, and alternative approaches.",
  "context": "This is a PostgreSQL database for a SaaS analytics platform. The 'events' table contains 15M rows of user activity data with timestamps, user_id, event_type, and metadata (JSONB). The monthly report needs to aggregate events by type and user for the last 30 days. Performance is critical as this blocks the monthly business report.",
  "code": "-- SLOW QUERY (45+ seconds)\nSELECT \n    u.id,\n    u.email,\n    u.plan_type,\n    COUNT(e.id) as event_count,\n    SUM(CASE WHEN e.event_type = 'login' THEN 1 ELSE 0 END) as login_count,\n    SUM(CASE WHEN e.event_type = 'purchase' THEN e.metadata->>'amount' ELSE 0 END) as total_spent\nFROM users u\nLEFT JOIN events e ON u.id = e.user_id \nWHERE e.created_at >= NOW() - INTERVAL '30 days'\n    AND e.created_at < NOW()\nGROUP BY u.id, u.email, u.plan_type\nHAVING COUNT(e.id) > 10\nORDER BY total_spent DESC NULLS LAST;\n\n-- TABLE STRUCTURES\n-- users: id (PK), email, plan_type, created_at, updated_at\n-- events: id (PK), user_id (FK), event_type, created_at, metadata (JSONB)\n-- Indexes: events_user_id_idx, events_created_at_idx, events_event_type_idx",
  "language": "sql",
  "expected_elements": [
    "Query performance analysis and bottleneck identification",
    "Index optimization strategy and implementation",
    "Query rewriting and execution plan improvement",
    "Partitioning or archiving recommendations",
    "Materialized view or summary table approach",
    "Connection pooling and configuration optimization",
    "Memory usage analysis and optimization",
    "Monitoring and alerting setup",
    "Benchmarking and performance measurement"
  ],
  "difficulty": "hard",
  "validates_techniques": ["challenge-framing"],
  "estimated_time": 60,
  "tags": ["database", "postgresql", "query-optimization", "performance", "indexing", "10m-rows"]
}